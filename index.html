<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>lessons</title>
        <script src="phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
                background: black;
            }
            

        </style>
    </head>
    <body>
                
    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(960, 420, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      
        function preload () {
            game.load.image('l0base', 'assets/l0_base.png');
            game.load.image('l0barriers', 'assets/l0_barriers.png');
            game.load.image('platform', 'assets/platform.png');
            game.load.image('blackbar', 'assets/blackbar.png');
            
            game.load.spritesheet('player', 'assets/player.png', 240, 420, 2);
            
            PIXI.scaleModes.DEFAULT = PIXI.scaleModes.NEAREST;
        }
        var cursors;
        
        var player;
       
        var currentLevel = 0;
        
        var barriersCollisionGroup;
        
        var platforms;
        var platformColour;
        
        var lessons;
        var lessonColour;
        
        var blackbars;
        var topBar, bottomBar, messageBar;
        var message;
        var dialogMode = false;
        
        // Phaser functions
                
        function create () {
            // Start physics and set general properties for game
            game.physics.startSystem(Phaser.Physics.ARCADE);
            
            game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
            game.scale.pageAlignVertically = true;
            game.stage.disableVisibilityChange = true;
            
            createBars();
            
            cursors = game.input.keyboard.createCursorKeys();
                    
            buildLevel(currentLevel);
                                                
            player = addPlayer(185, 138);

            createBars();
        }
        
        function update () {
            game.physics.arcade.collide(player, barriersCollisionGroup, barrierCollision);
            game.physics.arcade.collide(player, platforms);
            
            game.physics.arcade.collide(lessons, barriersCollisionGroup);
            game.physics.arcade.collide(lessons, platforms);
            
            game.physics.arcade.overlap(player, lessons, collectLesson);
            
            
            if (player.body.touching.down) { // On the ground or a platform
                if (cursors.left.isDown && player.body.velocity.x > -150 && !cursors.right.isDown) {
                    if (player.body.velocity.x > 0) { player.body.velocity.x = 0;}
                    player.body.velocity.x -= 30;
                } else if (cursors.right.isDown && player.body.velocity.x < 150 && !cursors.left.isDown) {
                    if (player.body.velocity.x < 0) { player.body.velocity.x = 0;}
                    player.body.velocity.x += 30;
                }
                
                if (player.body.velocity.x > 10) {
                    player.body.velocity.x -= 10;    
                } else if (player.body.velocity.x < -10) {
                        player.body.velocity.x += 10;
                } else {
                        player.body.velocity.x = 0;
                }

                
                if (cursors.up.isDown) {
                    player.body.velocity.y = -230;
                }
                
            } else { // In the air
                if (cursors.left.isDown && player.body.velocity.x > -100 && !cursors.right.isDown) {
                    if (player.body.velocity.x > 0) { player.body.velocity.x = 0;}
                    player.body.velocity.x -= 15;
                } else if (cursors.right.isDown && player.body.velocity.x < 100 && !cursors.left.isDown) {
                    if (player.body.velocity.x < 0) { player.body.velocity.x = 0;}
                    player.body.velocity.x += 15;
                }
                
            }
            
            if (player.body.velocity.x < 0) { player.frame = 1; }
            else if (player.body.velocity.x > 0) { player.frame = 0; }
            
            
            
        }
        
        // quinnn functions: less fun, more shuns
        
        function createBars() {
            blackbars = game.add.group();
            topBar = blackbars.create(0, 0, 'blackbar');
            topBar.scale.setTo(960,game.height/2);
            bottomBar = blackbars.create(0, game.height, 'blackbar');
            bottomBar.scale.setTo(960,game.height/2);
            bottomBar.anchor.y = 1;
            messageBar = blackbars.create(0, game.height / 2, 'blackbar');
            messageBar.scale.setTo(960,0); 
            messageBar.anchor.y = 0.5;
            openBars();
        }
        
        function openBars() {
            game.add.tween(topBar.scale).to({y: 0}, 1000, null, true);
            game.add.tween(bottomBar.scale).to({y: 0}, 1000, null, true);
            
        }
        
        function buildLevel(level) {
            addBase(level);
            addBarriers(level);
            addPlatforms(level);
            spawnLessons(currentLevel);
        }
        
        function addPlayer(x, y) {
            var player = game.add.sprite(x, y, 'player');
            player.scale.setTo(0.05, 0.05);
            
            game.physics.arcade.enable(player);
            
            player.body.bounce.y = 0.2;
            player.body.gravity.y = 580;
            player.body.collideWorldBounds = true;
            
            return player;
        }
        
        function addBarriers(level) {
            barriersCollisionGroup = game.add.group();
            barriersCollisionGroup.enableBody = true;
            
            game.add.sprite(0, 0, 'l' + level + 'barriers').scale.setTo(0.5, 0.5);

            switch (level) {
                case 0: // Level 0 : Homestead
                    // Ground
                    makeBarrier(0, 77, 192, 7);
                    
                    // Walls
                    makeBarrier(0, 17, 5, 27);
                    makeBarrier(0, 44, 18, 7);
                    makeBarrier(0, 51, 7, 20);
                    makeBarrier(156, 69, 36, 8);
                    makeBarrier(165, 62, 27, 7);
                    makeBarrier(171, 43, 21, 19);
                    makeBarrier(187, 9, 5, 34);
                    
                    // Stepped Levels
                    makeBarrier(0, 71, 17, 1);
                    makeBarrier(0, 72, 19, 1);
                    makeBarrier(0, 73, 21, 1);
                    makeBarrier(0, 74, 26, 1);
                    makeBarrier(0, 75, 61, 1);
                    makeBarrier(0, 76, 63, 1);
                    
                    makeBarrier(179, 40, 13, 1);
                    makeBarrier(177, 41, 15, 1);
                    makeBarrier(173, 42, 19, 1);
                    
                    break;
            }
        }
        
        function makeBarrier(xPos, yPos, xSize, ySize) {
            var barrier = barriersCollisionGroup.create(xPos*5, yPos*5, null);
            barrier.body.setSize(xSize*5, ySize*5);
            barrier.body.immovable = true;
        }
        
        function barrierCollision(sprite, barrier) {
            // Step up
            if (barrier.body.height < 6 && (sprite.body.touching.right || sprite.body.touching.left)) {
                sprite.body.velocity.y -= 30;
            }
            
        }
            
        function addPlatforms(level) {
            platforms = game.add.group();
            platforms.enableBody = true;
            switch (level) {
                case 0: // Level 0 : Homestead
                    platformColour = 0xe76600;
                    makePlatform(36, 33, 14);
                    makePlatform(65, 26, 60);
                    makePlatform(132, 32, 12);
                    makePlatform(121, 39, 11);
                    makePlatform(105, 43, 15);
                    makePlatform(96, 51, 7);
                    makePlatform(106, 56, 5);
                    makePlatform(114, 62, 7);
                    makePlatform(124, 69, 5);
                    
                    
                    break;
            }
            
        }
        
        function makePlatform(xPos, yPos, length) {
            var platform = platforms.create(xPos*5, yPos*5, 'platform');
            platform.scale.setTo(length, 1);
            platform.tint = platformColour;
            platform.body.immovable = true;
        }
            
        function addBase(level) {
            game.add.sprite(0, 0, 'l' + level + 'base').scale.setTo(0.5,0.5);
            switch (level) {
                case 0: game.stage.backgroundColor = '#fdde95'; break;
            }
        }
        
        function spawnLessons(level) {
            lessons = game.add.group();
            lessons.enableBody = true;
            switch (level) {
                case 0: // Level 0 : Homestead
                    lessonColour = 0xe76600;
                    spawnLesson(11, 67, 'Hopping up steps is all well and good, but jumping can get me so many more places!', 'jump');
                    spawnLesson(146, 73, '', '');
                    spawnLesson(40, 71, '', '');
                    spawnLesson(90, 22), '', '';
                    spawnLesson(10,40, '', '');
                    break;
            }
        }
        
        function spawnLesson(xPos, yPos, text, skill) {
            var lesson = lessons.create(xPos*5, yPos*5, 'player');
            lesson.scale.setTo(0.037, 0.037);
            lesson.tint = lessonColour;
            lesson.text = text;
            lesson.skill = skill;
            
            lesson.body.bounce.y = 0.9;
            lesson.body.gravity.y = 300;
            
            game.time.events.add(randTime(1000, 4000), bounceLesson, this, lesson);
            game.time.events.add(randTime(1000, 6000), turnLesson, this, lesson);

        }
        
        function bounceLesson(lesson) {
            if (lesson.alive) {
                lesson.body.velocity.y = -50;
                game.time.events.add(randTime(1000, 4000), bounceLesson, this, lesson);
            } 
        }
        
        function turnLesson(lesson) {
            if (lesson.alive) {
                lesson.frame = (lesson.frame + 1) % 2;
                game.time.events.add(randTime(1000, 6000), turnLesson, this, lesson);
            }
        }
        
        function randTime(min,max) {
            return Math.random() * (max - min) + min;
        }
        
        function collectLesson(player, lesson) {
            openDialog('Testing testing 1, 2, 3', lessonColour);
            lesson.kill();
        }
        
        function openDialog(text, colour) {
            // game.add.tween(messageBar.scale).to({y: 100}, 500, null, true);
            message = game.add.text(game.width/3, game.height/2, text, {font: "15px Arial", fill: colour});
            
        }
        
        

    };
    

    </script>

    </body>
</html>